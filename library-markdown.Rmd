---
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
```

This webpage is a very basic analysis of BCC libraries and their data. Included is an interactice map showing all BCC libraries, a simple graph showing some of the types of books borrowed at each library, and an interactive table that highlights the top borrowed from libraries each month. To filter through these features, simply select any of them from the tab below. 

```{r data load, echo=FALSE}
#loading libraries
library(rvest)
library(stringr)
library(purrr)
library(dplyr)
library(tidyverse)
library(plyr)
library(shiny)
library(dplyr)
library(lubridate)
library(leaflet)
library(sf)
library(sp)
library(ggplot2)
library(glue)
library(osrm)
library(smoothr)

#loading base website
base_website <- "https://www.data.brisbane.qld.gov.au/data/dataset/library-checkouts-branch-date"

#extracting links with library checkout data
urls <- read_html(base_website) %>%
  html_nodes("a") %>%
  html_attr("href") %>%
  str_subset("\\.zip") %>%
  as.list()

#extracting url link with acronym data
acronym_url <- read_html(base_website) %>%
  html_nodes("a") %>%
  html_attr("href") %>%
  str_subset("\\.csv$") 

#after reading in file, it was found colnames are not same across files (have minor differences)
# as some are separated with a "." and others are not
#reading in initial dataframe and applying col names to each df so when appending there are no issues

#reading in initial file column names
temp_file <- tempfile()
#downloading file to a temp location
col_name_file <- download.file(url = urls[[1]],temp_file)
#unzipping file to get a csv
csv_col_name_df <- unzip(temp_file, list = T)
#reading csv and getting colnames from file
csv_col_names <- colnames(read.csv(unz(temp_file,csv_col_name_df$Name)))


#creating a function to download and read data from each zipped url file & apply same colnames to each file
test_function <- function (download_url) {
  #creating tempfile for url to download 
  temp <- tempfile()
  
  # downloading urls
  download.file(url = download_url, temp)
  
  #unzipping listed files
  list.files <- unzip(temp,list=TRUE)
  
  #reading unzipped listed files
  data <- read.csv(unz(temp,list.files$Name[1]))
  
  #applying same colnames to each df
  colnames(data) <- csv_col_names
  
  #returning the dataframe read in
  return(data)
  
}

#creating list of dataframes from each downloaded file
test <- map(urls,test_function)

#appending all library records into one dataframe
dataframe <- ldply(test, rbind)

#cleaning checkout df to have dates in useful format etc.
checkouts <- dataframe %>%
  mutate(Datetime = as_datetime(
    paste0(str_sub(Date, 1,4),
           "-", 
           str_sub(Date,5,6),
           "-", 
           str_sub(Date,7,8),
           " ",
           str_sub(Date,9,10),
           ":",
           str_sub(Date,11,12),
           ":",
           str_sub(Date,13,14)),
    format = "%Y-%m-%d %H:%M:%S"),
    Date = as_date(Datetime))

#reading in acronym url data
acronym_df <- read.csv(acronym_url)

#splitting acronum url data into 3 data sets for easier use later on
#branch split
branch_df <- acronym_df[,1:2] %>%
  #removing all blank rows
  filter(Branch.Code!= "") %>%
  add_row(Branch.Code = "KEN", Branch.Heading = "Kenmore")

#heading split
heading_df <- acronym_df[,4:5] %>%
  #removing all blank rows
  filter(Heading != "")

projcrs <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"

#loading library locations dataset
library_locations <- read.csv("https://www.data.brisbane.qld.gov.au/data/dataset/6fc6ea2a-46d5-4339-a4b9-0f63ce5cfac4/resource/0f223803-897b-46e3-8fbb-930ad1925673/download/brisbane-city-council-libraries-information-dec-2020.csv") %>% 
  #adding a name variable to make it easier to join to other datasets without a branch code
  mutate(name = gsub("Library", "", Venue),
         lon = Longitude,
         lat = Latitude) %>%
  #converting the long & lat to coords for easier plotting
  st_as_sf(coords = c("Longitude", "Latitude"), crs = st_crs(4326))

```

### Choose a Tab {.tabset .tabset-fade .tabset-dropdown}
#### Map of libraries across Brisbane

Below is a map of libraries located across Brisbane, and this map now includes approximate drive times from a single library. This was done to assess if there are potential areas that could require new libraries to be built.

```{r library_map, echo=FALSE, message=FALSE, warning=FALSE}
#creating a book icon for the map markers of libraries
iconSet <- awesomeIconList(
  library = makeAwesomeIcon(
    icon = 'book',
    library = 'fa',
    iconColor = 'gold',
    markerColor = 'blue',
    spin = F)
)

#creating the isochrones (distances from libraries)
isochrone <- map2(library_locations$lon, library_locations$lat, 
                  ~ osrmIsochrone(loc = c(.x, .y),
                                  breaks = seq(0, 10, 2), returnclass = "sf", res = 50)) %>% do.call(what = rbind)
#making sure the geometries are valid
isochrone <- st_make_valid(isochrone)

#iso <- isochrone %>% group_by(min, max) %>% st_union()

#creating a function to calculate a geometry for each distance from the libraries
isochrones_function <- function(i) {
  isochrone_test <- isochrone %>% filter(id == i)
  isochrones_union <- st_union(isochrone_test) %>% st_transform("+init=epsg:4326")
  return(isochrones_union)
}

#creating the 
isochrone1 <- isochrones_function(1) %>% smooth(method = "chaikin", refinements = 5)
isochrone2 <- isochrones_function(2) %>% smooth(method = "chaikin", refinements = 5)
isochrone3 <- isochrones_function(3) %>% smooth(method = "chaikin", refinements = 5)
isochrone4 <- isochrones_function(4) %>% smooth(method = "chaikin", refinements = 5)
isochrone5 <- isochrones_function(5) %>% smooth(method = "chaikin", refinements = 5)


  
#plotting libraries on map
leaflet() %>%
  addProviderTiles("Stamen.TonerLite", group = "Base") %>%
  addProviderTiles(providers$OpenStreetMap, group = "Street map") %>%
  addAwesomeMarkers(data = library_locations,
                    label = library_locations$Venue,
                    icon = ~iconSet,
                    group = "libraries") %>%
  addPolygons(data = isochrone5,
              fillOpacity=0.25,
              fill = T,
              fillColor = "blue",
              opacity = 0,
              popup = "8-10 minutes from a library",
              group = "Drive time") %>%
  addPolygons(data = isochrone4,
              fillOpacity=0.4,
              fill = T,
              fillColor = "green",
              opacity = 0,
              popup = "6-8 minutes from a library",
              group = "Drive time") %>%
  addPolygons(data = isochrone3,
              fillOpacity=0.5,
              fill = T,
              fillColor = "yellow",
              opacity = 0,
              popup = "4-6 minutes from a library",
              group = "Drive time") %>%
  addPolygons(data = isochrone2,
              fillOpacity=0.75,
              fill = T,
              fillColor = "orange",
              opacity = 0,
              popup = "2-4 minutes from a library",
              group = "Drive time") %>%
  addPolygons(data = isochrone1,
              fillOpacity=0.9,
              fill = T,
              fillColor = "red",
              opacity = 0,
              popup = "0-2 minutes from a library",
              group = "Drive time") %>%
  addLayersControl(baseGroups = c("Street map","Base"),
                   overlayGroups = c("libraries", "Drive time"),
                   options = layersControlOptions(collapsed = FALSE)) 



```

One thing to note is that the drive time approximation is quite rough, and this is due to there being limited computing power to run these complex geospatial calculations. With more time and computing power, the spatial aspects will improve significantly.


#### Types of borrowed books
```{r borrowed books, echo=FALSE}
checkouts_grouped <- checkouts %>%
  inner_join(branch_df, by = c("Checkout.Library" = "Branch.Code")) %>%
  #only missing library branch code is LHQ which i am unable to ascertain what this library is
  group_by(Branch.Heading, Age) %>%
  dplyr::summarise(count = n()) %>%
  filter(Age %in% c("ADULT","JUVENILE","YA"))
  

ggplot(data = checkouts_grouped) +
  geom_col(aes(fill = Age, y = count, x = Branch.Heading),
           position = "stack", show.legend = T)+
  theme_classic()+
  labs(x = "BCC Library Branch",
       y = "Number of books borrowed",
       title = "Number of books borrowed from each library by age category")+
  theme(axis.text.x = element_text(angle = 45, hjust = 0.95, size = 7))
```

#### Number of borrowed books by top libraries

This table shows the number of books borrowed by the top 3 libraries each month
```{r reactable table, echo=FALSE}
library(reactable)
library(crosstalk)
library(tidyr)

checkouts_grouped_month_year <- checkouts %>%
  inner_join(branch_df, by = c("Checkout.Library" = "Branch.Code")) %>%
  #only missing library branch code is LHQ which i am unable to ascertain what this library is
  group_by(Branch.Heading, format(Date, "%Y/%m")) %>%
  dplyr::summarise(count = n(),
            Date = format(Date, "%Y/%m")) %>%
  unique() %>%
  arrange(Date,
          -count) %>%
  ungroup() %>%
  group_by(Date)%>%
  top_n(n = 3, wt = count) %>%
  mutate(Branch1 = Branch.Heading,
         Branch1BookCount = count,
         Branch2 = lead(Branch.Heading, 1),
         Branch2BookCount = lead(count,1),
         Branch3 = lead(Branch.Heading,2),
         Branch3BookCount = lead(count,2),
         Comments_1 = glue("The library with the most books borrowed was {Branch1} Library with a total of {Branch1BookCount} books borrowed."),
         Comments_2 = glue("The library with the second most books borrowed was {Branch2} Library with a total of {Branch2BookCount} books borrowed."),
         Comments_3 = glue("The library with the third most books borrowed was {Branch3} Library with a total of {Branch3BookCount} books borrowed."),
         Details = NA) %>%
  top_n(n=1, wt = count) %>%
  select(-Branch.Heading,
         -`format(Date, "%Y/%m")`,
         -count)


#creating a colour pallette to help show the scale of numbers
bcc_pal <- function(x) rgb(colorRamp(c("#006bb7","gold"))(x),maxColorValue = 255)

shared_data <- SharedData$new(checkouts_grouped_month_year)

outtbl <-
  reactable(
    shared_data,
    searchable = T,
    filterable = T,
    columns = list(
      Date = colDef(show = T),
      Branch1 = colDef(show = T),
      Branch1BookCount= colDef(show = T,
                               format = colFormat(suffix = " books",
                                                  separators = F),
                               style = function(value) {
                                 normalised <- (value-min(checkouts_grouped_month_year$Branch1BookCount))/(max(checkouts_grouped_month_year$Branch1BookCount)-min(checkouts_grouped_month_year$Branch1BookCount))
          color <- bcc_pal(normalised)
          list(background = color)
        }),
      Branch2 = colDef(show = T),
      Branch2BookCount= colDef(show = T,
                               format = colFormat(suffix = " books",
                                                  separators = F)),
      Branch3 = colDef(show = T),
      Branch3BookCount= colDef(show = T,
                               format = colFormat(suffix = " books",
                                                  separators = F)),
      #hiding the individual comments columns
      Comments_1 = colDef(show = F),
    Comments_2 = colDef(show = F),
    Comments_3 = colDef(show = F),
      Details = colDef(
        name = "Comments",
        sortable = F,
        cell = function() htmltools::tags$button("Show comments"))
      ),
    #making the table be sorted by lift by default
    defaultSorted = "Date",
    defaultSortOrder = "desc",
    resizable = T,
    wrap = T,
    bordered = T,
    elementId = "library-checkouts-table",
    #combining all comments into a single popup when button is clicked
    onClick = JS("function(rowInfo,colInfo) {
                 // Only handle events on the details column
                 if (colInfo.id !== 'Details') {
                 return
                 }
                 // Display an alert dialog with details for the row
                 window.alert(JSON.stringify(rowInfo.row['Comments_1'],null,1) +
                 '\\n' + '\\n' +
                 JSON.stringify(rowInfo.row['Comments_2'],null,1)+
                 '\\n' + '\\n' + 
                 JSON.stringify(rowInfo.row['Comments_3'],null,1))
                 }")
  )


outtbl
```

